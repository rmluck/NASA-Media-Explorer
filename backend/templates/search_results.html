<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Search Results</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
        <link href="https://cdn.jsdelivr.net/npm/nouislider/dist/nouislider.min.css" rel="stylesheet">
        <style>
            .result_card {
                position: relative;
                overflow: hidden;
                border-radius: 10px;
                cursor: pointer;
            }
            .result_card img {
                width: 100%;
                height: 250px;
                object-fit: cover;
                transition: transform 0.3s ease;
            }
            .result_card:hover img {
                transform: scale(1.05);
            }
            .overlay {
                position: absolute;
                bottom: 0;
                left: 0;
                right: 0;
                background: rgba(0, 0, 0, 0.7);
                color: #FFF;
                padding: 10px;
                text-align: center;
                opacity: 0;
                transition: opacity 0.3s ease;
            }
            .result_card:hover .overlay {
                opacity: 1;
            }
        </style>
    </head>
    <body class="bg-dark text-light">
        <div class="container py-4">
            <h1 class="mb-4">Search Results for "{{ query }}"</h1>
            <div id="year-filter" class="my-4">
                <label for="year-range">Year Range</label>
                <div id="year-range"></div>
                <span id="year-range-values"></span>
            </div>
            <div id="media-filter" class="my-4">
                <label for="media-type">Media Type</label>
                <select id="media-type">
                    <option value="">All</option>
                    <option value="image">Images</option>
                    <option value="video">Videos</option>
                </select>
            </div>
            <div class="row g-4" id="results_grid">
                {% for item in results %}
                <div class="col-md-3 col-sm-6">
                    <div class="result_card">
                        <img src="{{ item.thumbnail }}" alt="{{ item.title }}">
                        <div class="overlay">{{ item.doc_id }}</div>
                    </div>
                </div>
                {% endfor %}
            </div>
            <div class="text-center my-4">
                <button id="load_more_btn" class="btn btn-primary">Load More</button>
            </div>
        </div>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/nouislider/dist/nouislider.min.js"></script>
        <script>
            let offset = {{ results|length }};
            const limit = {{ limit }};
            const query = "{{ query }}";
            const totalResults = {{ total_results }};
            let startYear = null;
            let endYear = null;
            let mediaType = "";

            const loadMoreBtn = document.getElementById("load_more_btn");
            const resultsGrid = document.getElementById("results_grid");
            const slider = document.getElementById("year-range");
            const yearValues = document.getElementById("year-range-values");
            const media = document.getElementById("media-type");

            noUiSlider.create(slider, {
                start: [1920, 2025],
                connect: true,
                range: {
                    "min": 1920,
                    "max": 2025
                },
                step: 1,
                tooltips: true,
                format: {
                    to: value => Math.round(value),
                    from: value => Number(value)
                }
            });

            slider.noUiSlider.on("update", function(values) {
                yearValues.textContent = `${values[0]} - ${values[1]}`;
            });

            slider.noUiSlider.on("change", function(values) {
                startYear = Number(values[0]);
                endYear = Number(values[1]);
                fetchResults({ reset: true });
            });

            media.addEventListener("change", (e) => {
                mediaType = e.target.value;
                fetchResults({ reset: true });
            });

            async function fetchResults({ reset = false } = {}) {
                if (reset) {
                    offset = 0;
                    resultsGrid.innerHTML = "";
                    loadMoreBtn.style.display = "block";
                }

                const params = new URLSearchParams();
                params.append("query", query);
                params.append("limit", limit);
                params.append("offset", offset);

                if (startYear) params.append("start_year", startYear);
                if (endYear) params.append("end_year", endYear);
                if (mediaType) params.append("media_type", mediaType);

                const res = await fetch(`/api/search?${params.toString()}`);
                if (!res.ok) {
                    console.error("Search API error", res.status);
                    return;
                }

                const data = await res.json();

                data.results.forEach(item => {
                    const col = document.createElement("div");
                    col.className = "col-md-3 col-sm-6";

                    col.innerHTML = `
                    <div class="result_card">
                        <img src="${item.thumbnail ?? '#'}" alt="${item.title}">
                        <div class="overlay">${item.title}</div>
                    </div>
                    `;
                    resultsGrid.appendChild(col);
                });

                offset += data.results.length;
                if (offset >= data.total_results) {
                    loadMoreBtn.style.display = "none";
                }
            }

            loadMoreBtn.addEventListener("click", () => fetchResults({ reset: false }));
            
            window.addEventListener("scroll", () => {
                if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 500) {
                    loadMoreBtn.click();
                }
            });
        </script>
        <footer>
            &copy; {{ year }} NASA Media Explorer
        </footer>
    </body>
</html>