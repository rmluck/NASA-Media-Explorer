<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Search Results</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
        <link href="https://cdn.jsdelivr.net/npm/nouislider/dist/nouislider.min.css" rel="stylesheet">
        <style>
            .result_card {
                position: relative;
                overflow: hidden;
                border-radius: 10px;
                cursor: pointer;
            }
            .result_card img {
                width: 100%;
                height: 250px;
                object-fit: cover;
                transition: transform 0.3s ease;
            }
            .result_card:hover img {
                transform: scale(1.05);
            }
            .overlay {
                position: absolute;
                bottom: 0;
                left: 0;
                right: 0;
                background: rgba(0, 0, 0, 0.7);
                color: #FFF;
                padding: 10px;
                text-align: center;
                opacity: 0;
                transition: opacity 0.3s ease;
            }
            .result_card:hover .overlay {
                opacity: 1;
            }
        </style>
    </head>
    <body class="bg-dark text-light">
        <div class="container py-4">
            <h1 class="mb-4">Search Results for "{{ query }}"</h1>
            <div id="year-filter" class="my-4">
                <label for="year-range">Year Range</label>
                <div id="year-range"></div>
                <span id="year-range-values"></span>
            </div>
            <div id="media-filter" class="my-4">
                <label for="media-type">Media Type</label>
                <select id="media-type">
                    <option value="">All</option>
                    <option value="image">Images</option>
                    <option value="video">Videos</option>
                </select>
            </div>
            <div class="row g-4" id="results_grid">
                {% for item in results %}
                <div class="col-md-3 col-sm-6">
                    <div class="result_card"
                         data-title="{{ item.title | default('N/A') }}"
                         data-description="{{ item.description | default('N/A') }}"
                         data-media-type="{{ item.media_type | default('N/A') }}"
                         data-date="{{ item.date_created | default('N/A') }}"
                         data-location="{{ item.location | default('N/A') }}"
                         data-center="{{ item.center | default('N/A') }}"
                         data-photographer="{{ item.photographer | default('N/A') }}"
                         data-keywords="{{ item.keywords|join(', ') | default('N/A') }}"
                         data-asset="{{ item.asset | default('N/A') }}"
                         data-thumbnail="{{ item.thumbnail | default('N/A') }}"
                         data-doc-id="{{ item.doc_id | default('N/A') }}">
                        <img src="{{ item.thumbnail }}" alt="{{ item.title }}">
                        <div class="overlay">{{ item.title }}</div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        <div class="modal fade" id="mediaModal" tabindex="-1" aria-labelledby="mediaModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-xl modal-dialog-centered">
                <div class="modal-content bg-dark text-light">
                    <div class="modal-header">
                        <h5 class="modal-title" id="mediaModalLabel"></h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body text-center">
                        <div id="mediaModalBody"></div>
                        <p id="mediaDescription" class="mt-3"></p>
                        <ul class="list-unstyled text-start mt-3">
                            <li><strong>Date Created:</strong> <span id="mediaDate"></span></li>
                            <li><strong>Location:</strong> <span id="mediaLocation"></span></li>
                            <li><strong>Center:</strong> <span id="mediaCenter"></span></li>
                            <li><strong>Photographer:</strong> <span id="mediaPhotographer"></span></li>
                            <li><strong>Keywords:</strong> <span id="mediaKeywords"></span></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/nouislider/dist/nouislider.min.js"></script>
        <script>
            let offset = {{ results|length }};
            const limit = {{ limit }};
            const query = "{{ query }}";
            const totalResults = {{ total_results }};
            let startYear = null;
            let endYear = null;
            let mediaType = "";
            let loading = false;

            const resultsGrid = document.getElementById("results_grid");
            const slider = document.getElementById("year-range");
            const yearValues = document.getElementById("year-range-values");
            const media = document.getElementById("media-type");

            const modal = new bootstrap.Modal(document.getElementById("mediaModal"));
            const modalTitle = document.getElementById("mediaModalLabel");
            const modalBody = document.getElementById("mediaModalBody");
            const modalDescription = document.getElementById("mediaDescription");
            const modalDate = document.getElementById("mediaDate");
            const modalLocation = document.getElementById("mediaLocation");
            const modalCenter = document.getElementById("mediaCenter");
            const modalPhotographer = document.getElementById("mediaPhotographer");
            const modalKeywords = document.getElementById("mediaKeywords");

            noUiSlider.create(slider, {
                start: [1920, 2025],
                connect: true,
                range: {
                    "min": 1920,
                    "max": 2025
                },
                step: 1,
                tooltips: true,
                format: {
                    to: value => Math.round(value),
                    from: value => Number(value)
                }
            });

            slider.noUiSlider.on("update", function(values) {
                yearValues.textContent = `${values[0]} - ${values[1]}`;
            });

            slider.noUiSlider.on("change", function(values) {
                startYear = Number(values[0]);
                endYear = Number(values[1]);
                fetchResults({ reset: true });
            });

            media.addEventListener("change", (e) => {
                mediaType = e.target.value;
                fetchResults({ reset: true });
            });

            async function fetchResults({ reset = false } = {}) {
                if (reset) {
                    offset = 0;
                    resultsGrid.innerHTML = "";
                }

                const params = new URLSearchParams();
                params.append("query", query);
                params.append("limit", limit);
                params.append("offset", offset);

                if (startYear) params.append("start_year", startYear);
                if (endYear) params.append("end_year", endYear);
                if (mediaType) params.append("media_type", mediaType);

                const res = await fetch(`/api/search?${params.toString()}`);
                if (!res.ok) {
                    console.error("Search API error", res.status);
                    return;
                }

                const data = await res.json();

                data.results.forEach(item => {
                    const col = document.createElement("div");
                    col.className = "col-md-3 col-sm-6";

                    col.innerHTML = `
                    <div class="result_card"
                         data-title="${item.title}"
                         data-description="${item.description}"
                         data-media-type="${item.media_type}"
                         data-date="${item.date_created || "N/A"}"
                         data-location="${item.location || "N/A"}"
                         data-center="${item.center || "N/A"}"
                         data-photographer="${item.photographer || "N/A"}"
                         data-keywords="${item.keywords.join(', ') || "N/A"}"
                        data-asset="${item.asset}"
                         data-thumbnail="${item.thumbnail}"
                         data-doc-id="${item.doc_id}">
                        <img src="${item.thumbnail}" alt="${item.title}">
                        <div class="overlay">${item.title}</div>
                    </div>
                    `;
                    resultsGrid.appendChild(col);
                });

                offset += data.results.length;
            }

            function openModal(card) {
                const title = card.dataset.title;
                const description = card.dataset.description;
                const mediaType = card.dataset.mediaType.toLowerCase();
                const asset = card.dataset.asset;
                const thumbnail = card.dataset.thumbnail;

                modalTitle.textContent = title;
                modalDescription.textContent = description;
                modalDate.textContent = card.dataset.date;
                modalLocation.textContent = card.dataset.location;
                modalCenter.textContent = card.dataset.center;
                modalPhotographer.textContent = card.dataset.photographer;
                modalKeywords.textContent = card.dataset.keywords;

                modalBody.innerHTML = "";

                if (mediaType === "video") {
                    const video = document.createElement("video");
                    video.src = asset;
                    video.controls = true;
                    video.autoplay = false;
                    video.style.maxWidth = "100%";
                    modalBody.appendChild(video);
                } else {
                    const img = document.createElement("img");
                    img.src = asset;
                    img.alt = title;
                    img.style.maxWidth = "100%";
                    modalBody.appendChild(img);
                }

                modal.show();
            }

            window.addEventListener("scroll", async () => {
                if (loading) return;
                if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 500) {
                    if (offset < totalResults) {
                        loading = true;
                        await fetchResults({ reset: false });
                        loading = false;
                    }
                }
            });

            document.addEventListener("click", function(e) {
                const card = e.target.closest(".result_card");
                if (card) {
                    openModal(card);
                }
            });
        </script>
        <footer>
            &copy; {{ year }} NASA Media Explorer
        </footer>
    </body>
</html>