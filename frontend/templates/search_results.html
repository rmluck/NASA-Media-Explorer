<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Search Results</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
        <link href="https://cdn.jsdelivr.net/npm/nouislider/dist/nouislider.min.css" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500&family=Roboto:wght@400;700&family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
        <style>
            :root {
                --white: 255, 255, 255;
                --black: 0, 0, 0;
                --dark-blue-1: 10, 10, 48;
                --dark-blue-2: 26, 26, 64;
                --dark-blue-3: 0, 10, 32;
                --dark-blue-4: 10, 26, 64;
                --dark-blue-5: 10, 20, 40;
                --navy-blue: 31, 40, 51;
                --light-blue-1: 0, 191, 255;
                --light-blue-2: 48, 168, 207;
                --orange: 255, 145, 0;
                --dark-orange: 255, 112, 0;
                --light-orange: 255, 156, 51;
                --orange-red: 255, 120, 74;
            }
            body {
                display: flex;
                flex-direction: column;

                min-height: 100vh;

                background-color: rgb(var(--black));
                color: rgb(var(--white));

                font-family: "Roboto", sans-serif;
            }
            body::before {
                position: fixed;
                top: 0;
                left: 0;

                z-index: -2;
                content: "";

                width: 100%;
                height: 100%;

                background: linear-gradient(-45deg, rgb(var(--dark-blue-1)), rgb(var(--dark-blue-2)), rgb(var(--dark-blue-3)), rgb(var(--dark-blue-4)), rgb(var(--black)));
                background-size: 400% 400%;

                animation: gradientShift 60s ease infinite;
                pointer-events: none;
            }
            @keyframes gradientShift {
                0% { background-position: 0% 50% }
                50% { background-position: 100% 50% }
                100% { background-position: 0% 50% }
            }
            .stars {
                position: fixed;
                top: 0;
                left: 0;

                z-index: -1;

                width: 100%;
                height: 100%;
            }
            .star {
                position: absolute;
                
                opacity: 0.8;

                width: 2px;
                height: 2px;

                background-color: rgb(var(--white));
                border-radius: 50%;

                animation: twinkle 3s infinite ease-in-out alternate;
            }
            @keyframes twinkle {
                0% { opacity: 0.2; transform: scale(1); }
                50% { opacity: 1; transform: scale(1.5); }
                100% { opacity: 0.2; transform: scale(1); }
            }
            main {
                display: flex;
                flex: 1 0 auto;
                flex-direction: column;
                align-items: center;
            }
            .search_header {
                position: relative;

                margin-top: 1rem;
                margin-bottom: 2rem;
                padding: 1.5rem;

                background-color: rgba(var(--dark-blue-5), 0.85);
                border: 1px solid rgba(var(--white), 0.1);
                border-radius: 12px;
                box-shadow: 0 0 20px rgba(var(--light-blue-1), 0.3), inset 0 0 10px rgba(var(--orange), 0.2);
            }
            .search_header::after {
                display: block;
                content: "";

                margin-top: 1rem;
                width: 100%;
                height: 2px;

                background: linear-gradient(90deg, rgb(var(--light-blue-1)), rgb(var(--orange-red)), rgb(var(--light-blue-1)));

                animation: moveGradient 3s linear infinite;
            }
            .search {
                display: flex;
                flex-wrap: wrap;
                justify-content: space-between;
                align-items: center;
                gap: 1rem;
            }
            #searchTitle {
                overflow: hidden;

                margin: 0;
                padding-top: 1rem;

                color: rgb(var(--light-blue-2));

                font-size: clamp(1.5rem, 2vw, 2rem);
                font-family: "Orbitron", sans-serif;
                text-shadow: 0 0 6px rgba(var(--light-blue-1), 0.8), 0 0 12px rgba(var(--light-blue-1), 0.5);
                text-overflow: ellipsis;
            }
            #searchBar {
                flex: 0.75;

                min-width: 200px;
            }
            #searchForm {
                padding: 0.5rem;

                background-color: rgba(var(--dark-blue-4), 0.75);
                border-radius: 8px;
                box-shadow: 0 0 8px rgba(var(--light-blue-1), 0.4), 0 0 4px rgba(var(--orange), 0.2);
            }
            #searchInput {
                padding: 0.5rem 0.75rem;

                background-color: rgba(var(--dark-blue-5), 0.85);
                border: 1px solid rgba(var(--light-blue-1), 0.6);
                border-radius: 6px;
                box-shadow: inset 0 0 5px rgba(var(--light-blue-1), 0.4);
                color: rgb(var(--light-blue-1));

                font-family: "Roboto", sans-serif;
            }
            #searchInput:focus {
                border-color: rgb(var(--orange));
                outline: none;
                box-shadow: 0 0 10px rgba(var(--orange), 0.6);
            }
            #searchInput::placeholder {
                color: rgba(var(--white), 0.8);
            }
            #searchButton {
                background-color: rgb(var(--orange));
                border: none;
                border-radius: 6px;
                box-shadow: 0 0 8px rgba(var(--orange), 0.5);
                color: rgb(var(--white));

                font-family: "Roboto", sans-serif;
                font-weight: 500;

                transition: all 0.2s ease;
            }
            #searchButton:hover {
                background-color: rgb(var(--light-orange));
                box-shadow: 0 0 12px rgba(var(--orange), 0.7);

                transform: translateY(-2px);
            }
            .filters {
                display: flex;
                flex-wrap: wrap;
                gap: 2rem;
            }
            .filters > div {
                flex: 1;

                min-width: 200px;
                padding: 0.75rem 1rem;

                background-color: rgba(var(--dark-blue-4), 0.75);
                border-radius: 8px;
                box-shadow: 0 0 8px rgba(var(--light-blue-1), 0.4), 0 0 4px rgba(var(--orange), 0.2);

                transition: transform 0.2s ease;
            }            
            .filters > div::before {
                display: inline-block;
                vertical-align: middle;
                content: "";

                margin-right: 0.5rem;
                width: 10px;
                height: 10px;

                background: linear-gradient(45deg, rgb(var(--light-blue-1)), rgb(var(--light-blue-2)));
                border-radius: 50%;
                box-shadow: 0 0 6px rgba(var(--light-blue-1), 0.8);
            }
            .filters > div:hover {
                box-shadow: 0 0 12px rgba(var(--light-blue-1), 0.6), 0 0 6px rgba(var(--orange), 0.3);

                transform: translateY(-2px) scale(1.02);
            }
            .filters label {
                margin-top: 0.4rem;

                color: rgb(var(--white));
                text-shadow: 0 0 4px rgba(var(--light-blue-1), 0.5);

                font-size: 0.9rem;
                font-family: "Roboto", sans-serif;
                text-transform: uppercase;
                letter-spacing: 1px;
                text-shadow: 0 0 4px rgba(var(--light-blue-1), 0.5);
                margin-top: 0.4rem;
            }
            #yearFilter {
                margin-left: 15px;
                margin-right: 22px;
                padding-top: 10px;
            }
            #yearRange {
                width: 100%;
            }
            #yearRange .noUi-connect {
                background: linear-gradient(90deg, rgb(var(--light-blue-1)), rgb(var(--orange-red)));
                border-radius: 4px;
                box-shadow: 0 0 10px rgba(var(--orange-red), 0.8);
            }
            #yearRange .noUi-handle {
                width: 40px;
                height: 40px;

                background: url("https://www.freeiconspng.com/uploads/blue-rocket-png-9.png") no-repeat center center;
                background-size: contain;
                border: none;
                box-shadow: none;

                cursor: grab;
            }
            #yearRange .noUi-handle:active {
                transform: scale(1.1) rotate(-5deg);
                transition: transform 0.1s ease;
            }
            #yearRange .noUi-handle::before, #yearRange .noUi-handle::after {
                display: none;
            }
            #yearRange .noUi-tooltip {
                padding: 2px 6px;

                background-color: rgb(var(--dark-blue-4));
                border-radius: 6px;
                color: rgb(var(--white));

                font-size: 0.8rem;
                font-weight: 500;

                transition: transform 0.15s ease, opacity 0.15s ease;
            }
            #yearRange .noUi-handle-upper .noUi-tooltip {
                transform: translateX(40%) translateY(95%);
            }
            #yearRange .noUi-handle-lower .noUi-tooltip {
                transform: translateX(-110%) translateY(95%);
            }
            #mediaFilter {
                flex: 0.2;
            }
            #mediaType {
                -webkit-appearance: none;
                -moz-appearance: none;
                appearance: none;

                width: 100%;
                padding: 0.5rem 1rem;

                background-color: rgb(var(--dark-blue-1));
                border-radius: 8px;
                color: rgb(var(--white));

                font-weight: 500;

                transition: all 0.2s ease;
                cursor: pointer;
            }
            #mediaType:hover, #mediaType:focus {
                background-color: rgb(var(--orange));
                border-color: rgb(var(--orange-red));
            }
            .results_container {
                margin-top: 2rem;
                padding: 1rem;
            }
            .result_card {
                position: relative;

                overflow: hidden;

                background-color: rgb(var(--dark-blue-4));
                border-radius: 15px;
                backdrop-filter: blur(4px);

                transition: transform 0.3s ease, box-shadow 0.3s ease;
                cursor: pointer;
            }
            .result_card.image {
                box-shadow: 0 8px 15px rgba(var(--light-blue-1), 0.4), 0 12px 40px rgba(var(--orange), 0.2);
            }
            .result_card:hover {
                transform: translateY(-5px) scale(1.02);
                cursor: pointer;
            }
            .result_card.image:hover {
                box-shadow: 0 12px 24px rgba(var(--light-blue-1), 0.6), 0 16px 50px rgba(var(--orange), 0.3);
            }
            .result_card.video {
                box-shadow: 0 8px 15px rgba(var(--orange), 0.4), 0 12px 40px rgba(var(--light-blue-1), 0.2);
            }
            .result_card.video:hover {
                box-shadow: 0 12px 24px rgba(var(--orange), 0.6), 0 16px 50px rgba(var(--light-blue-1), 0.3);
            }
            .card_thumbnail, .video_preview {
                display: block;
                z-index: 1;

                width: 100%;
                height: 250px;

                border-radius: 15px 15px 0 0;
                transition: transform 0.3s ease;
            }
            .video_preview {
                position: absolute;
                top: 0;
                left: 0;

                opacity: 0;

                transition: opacity 0.3s ease;
                pointer-events: none;
            }
            .result_card:hover .card_thumbnail {
                transform: scale(1.05);
            }
            .result_card.video:hover .card_thumbnail {
                opacity: 0;
            }
            .result_card.video:hover .video_preview {
                opacity: 1;
            }
            .media_badge {
                position: absolute;
                top: 0.5rem;
                right: 0.5rem;

                z-index: 2;

                padding: 0.25rem 0.5rem;

                border-radius: 5px;
                color: rgb(var(--white));

                font-size: 0.75rem;
                font-weight: bold;
                text-transform: uppercase;
            }
            .media_badge.video {
                background-color: rgba(var(--orange), 0.7);
            }
            .media_badge.image {
                background-color: rgba(var(--light-blue-1), 0.7);
            }
            .overlay {
                position: absolute;
                top: 0;
                bottom: 0;
                left: 0;
                right: 0;

                display: flex;
                justify-content: center;
                align-items: flex-end;
                opacity: 0;
                z-index: 2;

                padding: 10px;

                background: linear-gradient(to top, rgba(var(--black), 0.85), transparent);
                color: rgb(var(--white));

                text-align: center;

                transition: opacity 0.3s ease;
            }
            .result_card:hover .overlay {
                opacity: 1;
            }
            .modal {
                backdrop-filter: blur(12px);

                transition: opacity 0.3s ease, transform 0.3s ease;
            }
            .modal-content {
                background-color: rgba(var(--dark-blue-5), 0.85);
                border-radius: 12px;
                color: rgb(var(--white));

                font-family: "Orbitron", sans-serif;
            }
            .modal_video .modal-content {
                border: 2px solid rgb(var(--orange));
                box-shadow: 0 0 30px rgba(var(--orange), 0.5);
            }
            .modal_video .modal-header {
                border-bottom: 1px solid rgb(var(--orange));
                text-shadow: 0 0 6px rgba(var(--orange), 0.8);
            }
            .modal_video .modal-title, .modal_video .mission_label {
                color: rgb(var(--orange));
            }
            .modal_video video {
                border-radius: 10px;
                box-shadow: 0 0 20px rgba(var(--orange), 0.5);
            }
            .modal_video #downloadBtn {
                position: absolute;
                bottom: 0;
                right: 0;
                
                background-color: rgb(var(--orange));
                border: 1px solid rgb(var(--orange));
            }
            .modal_image .modal-content {
                border: 2px solid rgb(var(--light-blue-1));
                box-shadow: 0 0 30px rgba(var(--light-blue-1), 0.5);
            }
            .modal_image .modal-header {
                border-bottom: 1px solid rgb(var(--light-blue-1));
                text-shadow: 0 0 6px rgba(var(--light-blue-1), 0.8);
            }
            .modal_image .modal-title, .modal_image .mission_label {
                color: rgb(var(--light-blue-1));
            }
            .modal_image img {
                border-radius: 10px;
                box-shadow: 0 0 20px rgba(var(--light-blue-1), 0.5);
            }
            .modal_image #downloadBtn {
                position: absolute;
                bottom: 0;
                right: 0;

                background-color: rgb(var(--light-blue-1));
                border: 1px solid rgb(var(--light-blue-1));
            }
            .modal_body {
                position: relative;

                padding: 1.5rem;

                font-family: "Montserrat", sans-serif;
            }
            .mission_info {
                position: relative;

                margin-top: 1rem;
            }
            .mission_info::before {
                position: absolute;
                top: 50%;
                left: 50%;

                content: "";

                width: 120%;
                height: 120%;

                border-radius: 50%;

                transform: translate(-50%, -50%);
            }
            .modal_video .mission_info::before {
                border: 1px dashed rgba(var(--orange), 0.4);
            }
            .modal_image .mission_info::before {
                border: 1px dashed rgba(var(--light-blue-1), 0.4);
            }
            .modal_close_btn:hover {
                color: rgb(var(--orange));
            }
            #backToTop {
                position: fixed;
                bottom: 20px;
                right: 30px;

                opacity: 0;
                z-index: 99;

                padding: 12px 20px;

                background-color: rgb(var(--orange));
                border: none;
                border-radius: 50%;
                box-shadow: 0 6px 10px rgba(var(--white), 0.5);
                color: rgb(var(--white));

                font-size: 20px;

                transition: opacity 0.3s ease, transform 0.3s ease;
                cursor: pointer;
            }
            #backToTop.show {
                opacity: 1;

                transform: translateY(0);
            }
            #backToTop:hover {
                background-color: rgb(var(--light-blue-2));

                transition: background-color 0.3s ease;
            }
            footer {
                flex-shrink: 0;

                padding: 1rem;

                background-color: rgb(var(--navy-blue));

                text-align: center;
            }
            @media (max-width: 768px) {
                #searchTitle, #searchBar, #mediaFilter, #yearFilter {
                    flex: 1 1 100%;
                }
            }
            /* .modal-video #mediaModalBody video {
                border-radius: 10px;
                box-shadow: 0 0 20px rgba(255, 145, 0, 0.5);
            } */
        </style>
    </head>
    <body class="bg-dark text-light">
        <main class="flex-grow-1 d-flex flex-column align-items-center justify-content-center">
            <div class="container py-4">
                <div class="search_header">
                    <div class="search d-flex">
                        <div>
                            <h1 id="searchTitle" class="mb-4">Search Results for "{{ query }}"</h1>
                        </div>
                        <div id="searchBar" class="my-3">
                            <form id="searchForm" class="d-flex">
                                <input type="text" id="searchInput" name="query" class="form-control me-2" placeholder="Search NASA media library..." value="" required>
                                <button type="submit" id="searchButton" class="btn btn-primary">Search</button>
                            </form>
                        </div>
                    </div>
                    <div class="filters">
                        <div id="yearFilter" class="my-4">
                            <div class="year-labels">
                                <label for="yearRange" class="block font-semibold mb-2">Year Range</label>
                            </div>
                            <div id="yearRange"></div>
                        </div>
                        <div id="mediaFilter" class="my-4">
                            <label for="mediaType" class="block font-semibold mb-2">Media Type</label>
                            <select id="mediaType">
                                <option value="">All</option>
                                <option value="image">Images</option>
                                <option value="video">Videos</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="results_container">
                    <div class="row g-4" id="results_grid">
                        {% for item in results %}
                        <div class="col-md-3 col-sm-6">
                            <div class="result_card {{ item.media_type }}"
                                data-title="{{ item.title | default('N/A') }}"
                                data-description="{{ item.description | default('N/A') }}"
                                data-media-type="{{ item.media_type | default('N/A') }}"
                                data-date="{{ item.date_created | default('N/A') }}"
                                data-location="{{ item.location | default('N/A') }}"
                                data-center="{{ item.center | default('N/A') }}"
                                data-photographer="{{ item.photographer | default('N/A') }}"
                                data-keywords="{{ item.keywords|join(', ') | default('N/A') }}"
                                data-asset="{{ item.asset | default('N/A') }}"
                                data-thumbnail="{{ item.thumbnail | default('N/A') }}"
                                data-doc-id="{{ item.doc_id | default('N/A') }}">
                                <img src="{{ item.thumbnail }}" alt="{{ item.title }}" class="card_thumbnail">
                                {% if item.media_type == 'video' %}
                                    <video class="video_preview" muted preload="metadata">
                                        <source src="{{ item.asset }}" type="video/mp4">
                                    </video>
                                {% endif %}
                                <span class="media_badge {{ item.media_type }}">{{ item.media_type | capitalize }}</span>
                                <div class="overlay">{{ item.title }}</div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>   
            </div>
            <div class="modal fade" id="mediaModal" tabindex="-1" aria-labelledby="mediaModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-xl modal-dialog-centered">
                    <div class="modal-content bg-dark text-light">
                        <div class="modal-header">
                            <h5 class="modal-title" id="mediaModalLabel"></h5>
                            <button type="button" class="btn-close btn-close-white modal_close_btn" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal_body text-center">
                            <div id="mediaModalBody"></div>
                            <p id="mediaDescription" class="mt-3" style="text-align: left;"></p>
                            <div class="mission_info">
                                <ul class="list-unstyled text-start mt-3">
                                    <li><strong class="mission_label">Date</strong>: <span id="mediaDate"></span></li>
                                    <li><strong class="mission_label">Location</strong>: <span id="mediaLocation"></span></li>
                                    <li><strong class="mission_label">Center</strong>: <span id="mediaCenter"></span></li>
                                    <li><strong class="mission_label">Photographer</strong>: <span id="mediaPhotographer"></span></li>
                                    <li><strong class="mission_label">Keywords</strong>: <span id="mediaKeywords"></span></li>
                                </ul>
                            </div>
                        </div>
                        <div class="modal_footer">
                            <a id="downloadBtn" class="btn btn-primary" target="_blank">Download</a>
                        </div>
                    </div>
                </div>
            </div>
            <button id="backToTop" title="Go to top">â†‘</button>
        </main>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/nouislider/dist/nouislider.min.js"></script>
        <script>
            let offset = {{ results|length }};
            const limit = {{ limit }};
            const query = "{{ query }}";
            const totalResults = {{ total_results }};
            let startYear = null;
            let endYear = null;
            let mediaType = "";
            let loading = false;

            const resultsGrid = document.getElementById("results_grid");
            const slider = document.getElementById("yearRange");
            const media = document.getElementById("mediaType");
            const searchForm = document.getElementById("searchForm");
            const searchInput = document.getElementById("searchInput");
            const modal = new bootstrap.Modal(document.getElementById("mediaModal"));
            const modalTitle = document.getElementById("mediaModalLabel");
            const modalBody = document.getElementById("mediaModalBody");
            const modalDescription = document.getElementById("mediaDescription");
            const modalDate = document.getElementById("mediaDate");
            const modalLocation = document.getElementById("mediaLocation");
            const modalCenter = document.getElementById("mediaCenter");
            const modalPhotographer = document.getElementById("mediaPhotographer");
            const modalKeywords = document.getElementById("mediaKeywords");
            const downloadBtn = document.getElementById("downloadBtn");
            const backToTopBtn = document.getElementById("backToTop");
            const starsContainer = document.createElement("div");
            const mediaModalElement = document.getElementById("mediaModal");

            starsContainer.classList.add("stars");
            document.body.appendChild(starsContainer);

            for (let i = 0; i < 200; i++) {
                const star = document.createElement("div");
                star.classList.add("star");
                star.style.top = Math.random() * window.innerHeight + "px";
                star.style.left = Math.random() * window.innerWidth + "px";
                star.style.animationDuration = 1 + Math.random() * 3 + "s";
                starsContainer.appendChild(star);
            }

            searchForm.addEventListener("submit", (e) => {
                e.preventDefault();
                const newQuery = searchInput.value.trim();
                if (newQuery) {
                    window.location.href = `/search?query=${encodeURIComponent(newQuery)}`;
                }
            });

            noUiSlider.create(slider, {
                start: [1920, 2025],
                connect: true,
                range: {
                    "min": 1920,
                    "max": 2025
                },
                step: 1,
                tooltips: true,
                format: {
                    to: value => Math.round(value),
                    from: value => Number(value)
                },
                pips: {
                    mode: "values",
                    values: [1920, 1930, 1940, 1950, 1960, 1970, 1980, 1990, 2000, 2010, 2020],
                    density: 4
                }
            });

            slider.noUiSlider.on("change", function(values) {
                startYear = Number(values[0]);
                endYear = Number(values[1]);
                fetchResults({ reset: true });
            });

            media.addEventListener("change", (e) => {
                mediaType = e.target.value;
                fetchResults({ reset: true });
            });

            function escapeAttr(str) {
                return str.replace(/&/g, "&amp;")
                          .replace(/"/g, "&quot;")
                          .replace(/'/g, "&#39;")
                          .replace(/</g, "&lt;")
                          .replace(/>/g, "&gt;");
            }

            async function fetchResults({ reset = false } = {}) {
                if (reset) {
                    offset = 0;
                    resultsGrid.innerHTML = "";
                }

                const params = new URLSearchParams();
                params.append("query", query);
                params.append("limit", limit);
                params.append("offset", offset);

                if (startYear) params.append("start_year", startYear);
                if (endYear) params.append("end_year", endYear);
                if (mediaType) params.append("media_type", mediaType);

                const res = await fetch(`/api/search?${params.toString()}`);
                if (!res.ok) {
                    console.error("Search API error", res.status);
                    return;
                }

                const data = await res.json();

                data.results.forEach(item => {
                    const col = document.createElement("div");
                    col.className = "col-md-3 col-sm-6";

                    col.innerHTML = `
                    <div class="result_card ${item.media_type}"
                         data-title="${escapeAttr(item.title)}"
                         data-description="${escapeAttr(item.description)}"
                         data-media-type="${escapeAttr(item.media_type)}"
                         data-date="${escapeAttr(item.date_created || "N/A")}"
                         data-location="${escapeAttr(item.location || "N/A")}"
                         data-center="${escapeAttr(item.center || "N/A")}"
                         data-photographer="${escapeAttr(item.photographer || "N/A")}"
                         data-keywords="${escapeAttr(item.keywords.join(', ') || "N/A")}"
                         data-asset="${escapeAttr(item.asset)}"
                         data-thumbnail="${escapeAttr(item.thumbnail)}"
                         data-doc-id="${escapeAttr(item.doc_id)}">
                        <img src="${escapeAttr(item.thumbnail)}" alt="${escapeAttr(item.title)}" class="card_thumbnail">
                        ${item.media_type === "video" ? '<video class="video_preview" muted preload="metadata"><source src="' + escapeAttr(item.asset) + '" type="video/mp4"></video>' : ''}
                        <span class="media_badge ${escapeAttr(item.media_type)}">${escapeAttr(item.media_type)}</span>
                        <div class="overlay">${escapeAttr(item.title)}</div>
                    </div>
                    `;
                    resultsGrid.appendChild(col);
                });

                offset += data.results.length;
            }

            document.addEventListener("click", function(e) {
                const card = e.target.closest(".result_card");
                if (card) {
                    openModal(card);
                }
            });

            function openModal(card) {
                const modalElement = document.getElementById("mediaModal");
                modalElement.classList.remove("modal_video", "modal_image");

                const title = card.dataset.title;
                const description = card.dataset.description;
                const mediaType = card.dataset.mediaType.toLowerCase();
                const asset = card.dataset.asset;
                const thumbnail = card.dataset.thumbnail;


                modalTitle.textContent = title || "N/A";
                modalDescription.textContent = description || "N/A";
                modalDate.textContent = card.dataset.date || "N/A";
                modalLocation.textContent = card.dataset.location || "N/A";
                modalCenter.textContent = card.dataset.center || "N/A";
                modalPhotographer.textContent = card.dataset.photographer || "N/A";
                modalKeywords.textContent = card.dataset.keywords || "N/A";

                modalBody.innerHTML = "";

                if (mediaType === "video") {
                    const video = document.createElement("video");
                    video.src = asset;
                    video.controls = true;
                    video.autoplay = false;
                    video.style.maxWidth = "100%";
                    modalElement.classList.add("modal_video");
                    modalBody.appendChild(video);
                } else {
                    const img = document.createElement("img");
                    img.src = asset;
                    img.alt = title;
                    img.style.maxWidth = "100%";
                    modalElement.classList.add("modal_image");
                    modalBody.appendChild(img);
                }

                downloadBtn.href = asset;

                modal.show();
            }

            
            mediaModalElement.addEventListener("hidden.bs.modal", () => {
                const video = mediaModalElement.querySelector("video");
                if (video) {
                    video.pause();
                    video.currentTime = 0;
                }
            });

            window.addEventListener("scroll", async () => {
                if (loading) return;
                if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 500) {
                    if (offset < totalResults) {
                        loading = true;
                        await fetchResults({ reset: false });
                        initVideoHover();
                        loading = false;
                    }
                }
            });

            window.addEventListener("scroll", () => {
                if (window.scrollY > 300) {
                    backToTopBtn.classList.add("show");
                } else {
                    backToTopBtn.classList.remove("show");
                }
            });

            backToTopBtn.addEventListener("click", () => {
                window.scrollTo({
                    top: 0,
                    behavior: "smooth"
                });
            });

            function initVideoHover() {
                document.querySelectorAll(".result_card.video").forEach(card => {
                    const video = card.querySelector(".video_preview");
                    card.addEventListener("mouseenter", () => {
                        video.currentTime = 0;
                        video.play();
                    });
                    card.addEventListener("mouseleave", () => {
                        video.pause();
                        video.currentTime = 0;
                    });
                    video.addEventListener("timeupdate", () => {
                        if (video.currentTime >= 5) {
                            video.pause();
                            video.currentTime = 0;
                        }
                    });
                });
            }
            initVideoHover();
        </script>
        <footer>
            &copy; {{ year }} NASA Media Explorer
        </footer>
    </body>
</html>